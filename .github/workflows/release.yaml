name: Build and Release

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        runs-on: macos-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Install Sparkle tools
              run: |
                  brew install sparkle

            - name: Import Code-Signing Certificates
              uses: apple-actions/import-codesign-certs@v2
              with:
                  p12-file-base64: ${{ secrets.P12_FILE_BASE64 }}
                  p12-password: ${{ secrets.P12_PASSWORD }}

            - name: Build app
              run: |
                  xcodebuild -scheme BrewManager \
                    -configuration Release \
                    -archivePath ./build/BrewManager.xcarchive \
                    -skipPackagePluginValidation \
                    -skipMacroValidation \
                    archive

                  xcodebuild -exportArchive \
                    -archivePath ./build/BrewManager.xcarchive \
                    -exportPath ./build \
                    -skipPackagePluginValidation \
                    -skipMacroValidation \
                    -exportOptionsPlist ExportOptions.plist

            - name: Create ZIP
              run: |
                  cd build
                  ditto -c -k --sequesterRsrc --keepParent BrewManager.app BrewManager.zip
                  ZIP_SIZE=$(stat -f%z BrewManager.zip)
                  echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

            - name: Create DMG
              run: |
                  # Install create-dmg if not available
                  brew install create-dmg || true
                  
                  # Create DMG
                  create-dmg \
                    --volname "BrewManager" \
                    --window-pos 200 120 \
                    --window-size 800 400 \
                    --icon-size 100 \
                    --icon "BrewManager.app" 200 190 \
                    --hide-extension "BrewManager.app" \
                    --app-drop-link 600 185 \
                    "build/BrewManager.dmg" \
                    "build/BrewManager.app"

            - name: Sign update
              env:
                  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
              run: |
                  # Find the sign_update executable
                  SIGN_UPDATE_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "sign_update" -type f | head -n 1)
                  if [ -z "$SIGN_UPDATE_PATH" ]; then
                    echo "Error: sign_update not found."
                    exit 1
                  fi
                  
                  # Create a temporary file for the private key
                  KEY_PATH=$(mktemp)
                  echo "$SPARKLE_PRIVATE_KEY" > "$KEY_PATH"

                  # Sign the update
                  SIGNATURE=$("$SIGN_UPDATE_PATH" build/BrewManager.zip "$KEY_PATH" | grep "sparkle:edSignature" | cut -d'"' -f2)
                  echo "SIGNATURE=$SIGNATURE" >> $GITHUB_ENV

                  # Clean up the temporary key file
                  rm "$KEY_PATH"

            - name: Get version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  if [ "$VERSION" = "${GITHUB_REF}" ]; then
                    VERSION=${{ github.event.inputs.version }}
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Update appcast.xml
              run: |
                  DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
                  cat > appcast.xml << EOF
                  <?xml version="1.0" encoding="utf-8"?>
                  <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
                      <channel>
                          <title>BrewManager</title>
                          <item>
                              <title>Version ${{ env.VERSION }}</title>
                              <sparkle:version>${{ env.VERSION }}</sparkle:version>
                              <sparkle:minimumSystemVersion>26.0</sparkle:minimumSystemVersion>
                              <pubDate>${DATE}</pubDate>
                              <enclosure url="https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/BrewManager.zip"
                                         sparkle:edSignature="${{ env.SIGNATURE }}"
                                         length="${{ env.ZIP_SIZE }}"
                                         type="application/octet-stream"/>
                          </item>
                      </channel>
                  </rss>
                  EOF

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: Update appcast for v${{ env.VERSION }}
                  title: "Update appcast for v${{ env.VERSION }}"
                  body: "This PR updates the appcast.xml for the new release."
                  branch: update-appcast-v${{ env.VERSION }}
                  base: main
                  delete-branch: true

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/BrewManager.zip
                      build/BrewManager.dmg
                  body: |
                      ## Changes in v${{ env.VERSION }}

                      Download BrewManager.dmg for easy installation, or BrewManager.zip for Sparkle updates.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
