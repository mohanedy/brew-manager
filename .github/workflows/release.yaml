name: Build and Release

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        runs-on: macos-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Install Sparkle tools
              run: |
                  brew install sparkle

            - name: Import Code-Signing Certificates
              uses: apple-actions/import-codesign-certs@v2
              with:
                  p12-file-base64: ${{ secrets.P12_FILE_BASE64 }}
                  p12-password: ${{ secrets.P12_PASSWORD }}

            - name: Build app
              run: |
                  xcodebuild -scheme BrewManager \
                    -configuration Release \
                    -archivePath ./build/BrewManager.xcarchive \
                    -skipPackagePluginValidation \
                    -skipMacroValidation \
                    archive

                  xcodebuild -exportArchive \
                    -archivePath ./build/BrewManager.xcarchive \
                    -exportPath ./build \
                    -skipPackagePluginValidation \
                    -skipMacroValidation \
                    -exportOptionsPlist ExportOptions.plist

            - name: Create ZIP
              run: |
                  cd build
                  ditto -c -k --sequesterRsrc --keepParent BrewManager.app BrewManager.zip
                  ZIP_SIZE=$(stat -f%z BrewManager.zip)
                  echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

            - name: Create DMG
              run: |
                  # Install create-dmg if not available
                  brew install create-dmg || true
                  
                  # Create DMG
                  create-dmg \
                    --volname "BrewManager" \
                    --window-pos 200 120 \
                    --window-size 800 400 \
                    --icon-size 100 \
                    --icon "BrewManager.app" 200 190 \
                    --hide-extension "BrewManager.app" \
                    --app-drop-link 600 185 \
                    "build/BrewManager.dmg" \
                    "build/BrewManager.app"

            - name: Setup Sparkle private key
              env:
                  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
              run: |
                  # Create a temporary file for the private key and add to keychain
                  KEY_PATH=$(mktemp)
                  echo "$SPARKLE_PRIVATE_KEY" > "$KEY_PATH"
                  
                  # Store key path for later use
                  echo "SPARKLE_KEY_PATH=$KEY_PATH" >> $GITHUB_ENV

            - name: Get version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  if [ "$VERSION" = "${GITHUB_REF}" ]; then
                    VERSION=${{ github.event.inputs.version }}
                  fi
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Update appcast.xml
              run: |
                  # Find the generate_appcast executable
                  GENERATE_APPCAST_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "generate_appcast" -type f | head -n 1)
                  
                  if [ -z "$GENERATE_APPCAST_PATH" ]; then
                    echo "Error: generate_appcast not found in Xcode DerivedData"
                    echo "Searching in common locations..."
                    find ~/Library/Developer -name "generate_appcast" -type f 2>/dev/null || true
                    exit 1
                  fi
                  
                  echo "Found generate_appcast at: $GENERATE_APPCAST_PATH"
                  
                  # Create a temporary directory for the release
                  RELEASE_DIR=$(mktemp -d)
                  cp build/BrewManager.zip "$RELEASE_DIR/"
                  
                  # Generate appcast with automatic signing
                  "$GENERATE_APPCAST_PATH" "$RELEASE_DIR" \
                    -o ./appcast.xml \
                    --download-url-prefix "https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/" \
                    --ed-key-file "$SPARKLE_KEY_PATH"
                  
                  # Clean up
                  rm -rf "$RELEASE_DIR"
                  
                  echo "Appcast generated successfully"
                  cat appcast.xml
            
            - name: Cleanup Sparkle key
              if: always()
              run: |
                  # Clean up the private key file
                  if [ -f "$SPARKLE_KEY_PATH" ]; then
                    rm "$SPARKLE_KEY_PATH"
                  fi

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: Update appcast for v${{ env.VERSION }}
                  title: "Update appcast for v${{ env.VERSION }}"
                  body: "This PR updates the appcast.xml for the new release."
                  branch: update-appcast-v${{ env.VERSION }}
                  base: main
                  delete-branch: true

            - name: Generate changelog
              id: changelog
              uses: TriPSs/conventional-changelog-action@v5
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  output-file: "false"

            - name: Create Release
              uses: softprops/action-gh-release@v2.4.1
              with:
                  files: |
                      build/BrewManager.zip
                      build/BrewManager.dmg
                  body: ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
