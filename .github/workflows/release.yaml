name: Build and Release

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        runs-on: macos-26

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Install Sparkle tools
              run: |
                  brew install sparkle

            - name: Build app
              run: |
                  xcodebuild -scheme BrewManager \
                    -configuration Release \
                    -archivePath ./build/BrewManager.xcarchive \
                    archive

                  xcodebuild -exportArchive \
                    -archivePath ./build/BrewManager.xcarchive \
                    -exportPath ./build \
                    -exportOptionsPlist ExportOptions.plist

            - name: Create ZIP
              run: |
                  cd build
                  ditto -c -k --sequesterRsrc --keepParent BrewManager.app BrewManager.zip
                  ZIP_SIZE=$(stat -f%z BrewManager.zip)
                  echo "ZIP_SIZE=$ZIP_SIZE" >> $GITHUB_ENV

            - name: Create DMG
              run: |
                  # Install create-dmg if not available
                  brew install create-dmg || true
                  
                  # Create DMG
                  create-dmg \
                    --volname "BrewManager" \
                    --window-pos 200 120 \
                    --window-size 800 400 \
                    --icon-size 100 \
                    --icon "BrewManager.app" 200 190 \
                    --hide-extension "BrewManager.app" \
                    --app-drop-link 600 185 \
                    "build/BrewManager.dmg" \
                    "build/BrewManager.app"

            - name: Sign update
              env:
                  SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
              run: |
                  # Import private key from secrets
                  security import <(echo "$SPARKLE_PRIVATE_KEY") -k ~/Library/Keychains/login.keychain-db

                  # Sign the update
                  SIGNATURE=$(sign_update build/BrewManager.zip | grep "sparkle:edSignature" | cut -d'"' -f2)
                  echo "SIGNATURE=$SIGNATURE" >> $GITHUB_ENV

            - name: Get version
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Update appcast.xml
              run: |
                  DATE=$(date -u +"%a, %d %b %Y %H:%M:%S %z")
                  cat > appcast.xml << EOF
                  <?xml version="1.0" encoding="utf-8"?>
                  <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">
                      <channel>
                          <title>BrewManager</title>
                          <item>
                              <title>Version ${{ env.VERSION }}</title>
                              <sparkle:version>${{ env.VERSION }}</sparkle:version>
                              <sparkle:minimumSystemVersion>26.0</sparkle:minimumSystemVersion>
                              <pubDate>${DATE}</pubDate>
                              <enclosure url="https://github.com/${{ github.repository }}/releases/download/v${{ env.VERSION }}/BrewManager.zip"
                                         sparkle:edSignature="${{ env.SIGNATURE }}"
                                         length="${{ env.ZIP_SIZE }}"
                                         type="application/octet-stream"/>
                          </item>
                      </channel>
                  </rss>
                  EOF

            - name: Commit appcast
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add appcast.xml
                  git commit -m "Update appcast for v${{ env.VERSION }}"
                  git push origin HEAD:main

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/BrewManager.zip
                      build/BrewManager.dmg
                  body: |
                      ## Changes in v${{ env.VERSION }}

                      Download BrewManager.dmg for easy installation, or BrewManager.zip for Sparkle updates.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
